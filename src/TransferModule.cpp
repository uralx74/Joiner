// -c="c:\7-test sqltext\nasel_ccb_ft\change_cal_period.xml" -l="log_nasel_ccb_ft.log" -a -aeq
// -c="c:\6\kavabunga\kavabunga.xml" -l="%dlog.log" -a -accce
//

#include "pch.h"
#pragma hdrstop
#include "TransferModule.h"

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------
__fastcall TTransferModule::TTransferModule()
{
    //Logger = Singleton::getInstance();
    //_IsCancel = false;
}

//---------------------------------------------------------------------------
// Отмена запуска потока
void __fastcall TTransferModule::Cancel()
{
    //_IsCancel = true;
}

//---------------------------------------------------------------------------
// Запуск
void __fastcall TTransferModule::Start()
{
    Logger = &TLogger::getInstance();

    //pParentThread = Thread;
    TXmlLoader* pXmlLoader = new TXmlLoader();

    if (pXmlLoader->LoadParameters())
    {
        Transfer(pXmlLoader->SrcStor, pXmlLoader->DstStor);
    }

    delete pXmlLoader;
}

//---------------------------------------------------------------------------
//
void __fastcall TTransferModule::Transfer(TStorage* Src, TStorage* Dst)
{
    if (!Src || !Dst)
    {
        Logger->WriteLog("Процедура копирования не может быть запущена, так как " +
            ((String)(!Src? "источник" : "приемник")) + " не задан.");
        return;
    }

    Logger->WriteLog("Copying data started started.");
    TDateTime StartTime = Now();


    int log_n;
    log_n = Logger->WriteLog("Opening Destination >");
    try
    {
        Dst->openTable(false);   // Открываем приемник
        Logger->WriteLog("Destination is opened successfully.", log_n);
    }
    catch (Exception &e)
    {
        Logger->WriteLog("Could not open the Destination \"" + Dst->getTable() + "\". " + e.Message, log_n);
        Dst->closeTable();
        Logger->WriteLog("The data copying procedure is complete.");
        return;
    }


   int DstRecordCountFirst = Dst->getRecordCount();



    //!!!!!!!!!!!!!!!!!!!!!!!!!!
    /*Sleep(1000);
    if (_IsCancel) {
        log_n = Logger->WriteLog("ПРЕРЫВАНИЕ");
        throw Exception("Start()");
    }*/

    while(!Src->eot())
    { // Цикл по таблицам
        try
        {
            log_n = Logger->WriteLog("Открытие источника >");
            Src->openTable(true);   // Открываем источник
            Logger->WriteLog("Source opened successfully.", log_n);
        }
        catch (Exception &e)
        {    // если ошибка, переходим на следующую таблицу
            Logger->WriteLog("Could not open Source \"" + Src->getTable()+ "\" (" + Src->getTableStage() + "). " + e.Message, log_n);
            Src->nextTable();
            continue;
        }


        // Если источник открыт успешно
        log_n = Logger->WriteLog("Processed > \"" + Src->getTable() + "\" (" + Src->getTableStage() + "; " + Src->getRecordStage()+")");

        try
        {
            // Здесь сделать подготовку приемника.
            // Чтото вроде ;
            // В приемнике необходимо отметить те поля, которым есть сопоставленные поля в источнике
            // Вывести список полей, которые необходимы (required), но которых нет в источнике
            // В зависимости от ключей командной строки, если такие поля обнаружатся, то останавливать цикл или продолжать

            Dst->linkSource(Src);

            int DstRecordCount = Dst->getRecordCount();

            while(!Src->eor())    // Цикл по строкам
            {
                //String sss = Src->getRecordStage();
                //if (Src->GetRecordIndex() % 100 == 0) {
                    //Logger->WriteLog("Загружается > \"" + Src->GetTable() + "\" (" + Src->getTableStage() + "; " + Src->getRecordStage() + ")",log_n);
                    //Logger->WriteLog("Загружается > \"" + Src->GetTable() + "\" (" + Src->getTableStage() + "; " + Src->getRecordStage() + ")");
                //}
                //Logger->WriteLog("Загружается > " + Src->GetTable() + " " + Src->GetStage(), log_n);

                Dst->append();

                while(!Dst->eof())     // Цикл по столбцам в приемнике
                {
                    bool isLinkedField = Dst->isLinkedField();
                    bool isActiveField = Dst->isActiveField();
                    TStorageField *field = Dst->getField();
                    if (isLinkedField && isActiveField)
                    {
                        Variant Value;
                        try
                        {
                            Value = Src->getFieldValue(field);
                        }
                        catch (Exception &e)
                        {
                            Logger->WriteLog("Problem with Source \"" + Src->getTable() + "\" (" + Src->getTableStage() + ")" + ". " + e.Message /*+ Dst->GetSrcField()*/, log_n);
                            throw Exception("");
                        }
                        try
                        {
                            Dst->setFieldValue(Value);
                        }
                        catch (Exception &e)
                        {
                            Logger->WriteLog("Problem with Destination \"" + Dst->getTable() + "\" (" + Dst->getTableStage() + ")" + ". " + e.Message /*+ Dst->GetSrcField()*/, log_n);
                            throw Exception("");
                        }
                    }
                    else if (isActiveField && field->forceValue)
                    {
                        Variant Value;
                        Value = field->value;

                        try
                        {
                            Dst->setFieldValue(Value);
                        }
                        catch (Exception &e)
                        {
                            Logger->WriteLog("Problem with Destination \"" + Dst->getTable() + "\" (" + Dst->getTableStage() + ")" + ". " + e.Message /*+ Dst->GetSrcField()*/, log_n);
                            throw Exception("");
                        }
                    }
                    Dst->nextField();
                }

                //if (Dst->IsModified()) {
                //    Dst->Post();
                //} else {
                //    Dst->Rollback();
                //}

                Dst->post();  // Фиксирует строку
                Src->nextRecord();
                //log_n = Logger->WriteLog(Src->getRecordIndex());
            }

            // Если источник открыт успешно
            //log_n = Logger->WriteLog("Фиксация >");
            Dst->commit();


            // Проверять, был ли хоть один Commit в приемнике
            // может быть использовать RecordIndex или RecordCount
            int LoadedRecordsCount = Dst->getRecordCount() - DstRecordCount;

            Logger->WriteLog("Loaded " + IntToStr(LoadedRecordsCount) + " recors of \"" + Src->getTable() + "\"", log_n);
            DstRecordCount = Dst->getRecordCount();

        }
        catch (Exception &e)
        {
            if (e.Message != "")
            {
                Logger->WriteLog("Unexpected error. Source: \"" + Src->getTable() + "\" (" + Src->getTableStage() + "), Destination \"" + Dst->getTable()+ "\". " + e.Message /*+ Dst->GetSrcField()*/);
            }
        }
        Src->nextTable();
    }

    // Формируем строку - секундомер
    TDateTime StopTime = Now() ;
    int TotalSec = SecsPerDay * (StopTime - StartTime);
    int hh = (TotalSec ) / 3600;
    int mm = (TotalSec - hh * 3600) / 60;
    int ss = TotalSec % 60;
    AnsiString sTotalTime = IntToStr(ss) + " sec";
    if (mm > 0)
    {
        sTotalTime = IntToStr(mm) + " min " + sTotalTime;
    }
    if (hh > 0)
    {
        sTotalTime = IntToStr(hh) + " hour " + sTotalTime;
    }


    int DstRecordCountTotal = Dst->getRecordCount() - DstRecordCountFirst;

    // Проверять, был ли хоть один Commit в приемнике
    // может быть использовать RecordIndex или RecordCount
    if (Dst->isModified())
    {
        Logger->WriteLog("Total loaded " + IntToStr(DstRecordCountTotal) + " records for " + sTotalTime+ ".");
        Logger->WriteLog("Результат сохранен в \"" + Dst->getTable() + "\".");
    }
    else
    {
        Logger->WriteLog("The Destination was not changed. Total time spent on the process: " + sTotalTime+ ".");
    }

    // Закрытие источника и приемника
    // Временно - закрытие последних открытых таблиц
    // в дальнейшем изменить на closeStorage();
    Src->closeTable();
    Dst->closeTable();

    Logger->WriteLog("The data copying procedure is complete.");
}


